---
title: "Análise dos dados da wikipedia com intervalo de confiança"
output: html_notebook
---
##Dados da wikipedia

O objeto principal da análise são as buscas e a navegação depois da busca. 

Aqui, exploramos esses dados. Esses dados são derivadoes dos dados originais de eventos (event logging (EL)) capturados pela Wikimedia Foundation.

```{r setup, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(resample) 
library(boot) 
theme_set(theme_bw())
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
events = read_csv("https://github.com/wikimedia-research/Discovery-Hiring-Analyst-2016/raw/master/events_log.csv.gz")

events = events %>% 
    group_by(session_id) %>% 
    arrange(timestamp) %>% 
    mutate(search_index = cumsum(action == "searchResultPage"), # contador de buscas na sessão.
           date = ymd_hms(timestamp))  %>% 
    ungroup()
```

Essa analise busca responder as quetões originais do desafio criado pela wikimedia. Primeiramente busco responde as duas perguntas que são relacionadas que são:

##What is our daily overall clickthrough rate? How does it vary between the groups?

```{r}
set.seed(1234)
funcao_bootstrap <- function(dado, indices) {

  TotalPorHora <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHora <- dado %>%
    filter(num_clicks > 0) %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultado = clickRateHora / TotalPorHora
  
  return(mean(resultado))
}

bootstraps <- boot(data = buscas, 
                 statistic = funcao_bootstrap, 
                 R = 2000)

summary(bootstraps$t)

boot.ci(boot.out = bootstraps, conf = 0.95, type = "basic")
```

A taxa de clique geral média encontrada na população com uma confiança de 95% está localizada no intervalo entre 24,24% e 24,72%.

#Comparando entre os grupos

```{r}

funcao_bootstrap <- function(dado, indices) {

  TotalPorHoraA <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'a')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraA <- dado %>%
    filter(num_clicks > 0) %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'a')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoA = clickRateHoraA / TotalPorHoraA
  
  TotalPorHoraB <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'b')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraB <- dado %>%
    slice(indices) %>% 
    filter(num_clicks > 0) %>%
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'b')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoB = clickRateHoraB / TotalPorHoraB
  
  return(mean(resultadoA) - mean(resultadoB))
}

bootstraps <- boot(data = buscas, 
                 statistic = funcao_bootstrap, 
                 R = 2000)

summary(bootstraps$t)

boot.ci(boot.out = bootstraps, conf = 0.95, type = "basic")
```
Como podemos ver pelo resultado da comparação, o intervalo não passa pelo 0 o que significa que com uma confiança de 95% podemos afirmar que há uma diferença significativa entre o grupo A e o grupo B na população. Essa diferença está entre 13,15% e 14,35% onde o grupo A tem taxas maiores que o grupo B.
##What is our daily overall zero results rate? How does it vary between the groups?
```{r}

funcao_bootstrap <- function(dado, indices) {

  TotalPorHora <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHora <- dado %>%
    filter(num_clicks == 0) %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultado = clickRateHora / TotalPorHora
  
  return(mean(resultado))
}

bootstraps <- boot(data = buscas, 
                 statistic = funcao_bootstrap, 
                 R = 2000)

summary(bootstraps$t)

boot.ci(boot.out = bootstraps, conf = 0.95, type = "basic")
```

A taxa de zero clique geral média encontrada na população com uma confiança de 95% está localizada no intervalo entre 75,05% e 75,68%.

#Comparando entre os grupos

```{r}

funcao_bootstrap <- function(dado, indices) {

  TotalPorHoraA <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'a')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraA <- dado %>%
    filter(num_clicks == 0) %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'a')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoA = clickRateHoraA / TotalPorHoraA
  
  TotalPorHoraB <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'b')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraB <- dado %>%
    slice(indices) %>% 
    filter(num_clicks == 0) %>%
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( group == 'b')%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoB = clickRateHoraB / TotalPorHoraB
  
  return(mean(resultadoA) - mean(resultadoB))
}

bootstraps <- boot(data = buscas, 
                 statistic = funcao_bootstrap, 
                 R = 2000)

summary(bootstraps$t)

boot.ci(boot.out = bootstraps, conf = 0.95, type = "basic")
```
Como podemos ver pelo resultado da comparação, o intervalo não passa pelo 0 o que significa que com uma confiança de 95% podemos afirmar que há uma diferença significativa entre o grupo A e o grupo B na população. Essa diferença está entre 13,24% e 14,35% onde o grupo B é maior que o grupo A.

##Testa o que acontece se para a pergunta 1, em vez de comparar o grupo A com o grupo B (um teste A/B), você compara metade das sessões do grupo A (escolhida aleatoriamente) com outra metade das sessões do mesmo grupo (um teste A/A).

```{r}

buscas_a <- buscas %>% filter(group == 'a')
smp_size <- floor(0.5 * nrow(buscas_a))
ind <- sample(seq_len(nrow(buscas_a)), size = smp_size)

train <- buscas_a[ind, ]%>%
  mutate(tipo = 1)
test <- buscas_a[-ind, ]%>%
  mutate(tipo = 2)

buscas_a <- bind_rows(test, train)

funcao_bootstrap <- function(dado, indices) {

  TotalPorHoraA <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( tipo == 1)%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraA <- dado %>%
    filter(num_clicks > 0) %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( tipo == 1)%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoA = clickRateHoraA / TotalPorHoraA
  
  TotalPorHoraB <- dado %>%
    slice(indices) %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( tipo == 2)%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)
  clickRateHoraB <- dado %>%
    slice(indices) %>% 
    filter(num_clicks > 0) %>%
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter( tipo == 2)%>% 
    group_by(session_start_date) %>%
    summarise(count=n())%>%
    pull(count)

  
  resultadoB = clickRateHoraB / TotalPorHoraB
  
  return(mean(resultadoA) - mean(resultadoB))
}

bootstraps <- boot(data = buscas_a, 
                 statistic = funcao_bootstrap, 
                 R = 2000)

summary(bootstraps$t)

boot.ci(boot.out = bootstraps, conf = 0.95, type = "basic")
```
Como esperado, podemos ver que o intervalo passa pelo zero, logo, com uma confiança de 95%, não podemos afirmar que existe uma diferença entre a média de clique entre os dois subconjuntos de A.

