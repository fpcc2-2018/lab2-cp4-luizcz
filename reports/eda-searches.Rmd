---
title: "Análise dos dados da wikipedia"
output: html_notebook
---
##Dados da wikipedia

O objeto principal da análise são as buscas e a navegação depois da busca. 

Aqui, exploramos esses dados. Esses dados são derivadoes dos dados originais de eventos (event logging (EL)) capturados pela Wikimedia Foundation.

```{r setup, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
events = read_csv("https://github.com/wikimedia-research/Discovery-Hiring-Analyst-2016/raw/master/events_log.csv.gz")

events = events %>% 
    group_by(session_id) %>% 
    arrange(timestamp) %>% 
    mutate(search_index = cumsum(action == "searchResultPage"), # contador de buscas na sessão.
           date = ymd_hms(timestamp))  %>% 
    ungroup()
```

Essa analise busca responder as quetões originais do desafio criado pela wikimedia. Primeiramente busco responde as duas perguntas que são relacionadas que são:

##What is our daily overall clickthrough rate? How does it vary between the groups?
##What is our daily overall zero results rate? How does it vary between the groups?

Para conseguirmos visualizar o comportamento dos dados iremos utilizar gráficos de barras para cada um dos grupos por dia.

```{r}
buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date, session_id, click, group)%>%
    summarise(num_clicks = median(num_clicks))%>%
    ggplot(aes(x = session_start_date)) + 
    geom_bar(aes(fill = click))+facet_grid(group ~ .)+
   labs(fill="")

```

Para ter uma repesentação mais concreta desse valor podemos quantificar utilizando a média do percentuais de todos os dias tanto para o grupo A como para o grupo B. 

```{r}
NumeroDeBuscasSemClickPorDiaGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "zero results rate" & group == 'a')%>%
    summarise(count=n())

NumeroDeBuscasComClickPorDiaGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "clickthrough rate" & group == 'a')%>%
    summarise(count=n())

NumeroDeBuscasTotalPorDiaGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter( group == 'a')%>%
    summarise(count=n())


mean(NumeroDeBuscasComClickPorDiaGrupoA$count/NumeroDeBuscasTotalPorDiaGrupoA$count)
mean(NumeroDeBuscasSemClickPorDiaGrupoA$count/NumeroDeBuscasTotalPorDiaGrupoA$count)


```

```{r}

NumeroDeBuscasSemClickPorDiaGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "zero results rate" & group == 'b')%>%
    summarise(count=n())
    

NumeroDeBuscasComClickPorDiaGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "clickthrough rate" & group == 'b')%>%
    summarise(count=n())

NumeroDeBuscasTotalPorDiaGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter( group == 'b')%>%
    summarise(count=n())

mean(NumeroDeBuscasComClickPorDiaGrupoB$count/NumeroDeBuscasTotalPorDiaGrupoB$count)
mean(NumeroDeBuscasSemClickPorDiaGrupoB$count/NumeroDeBuscasTotalPorDiaGrupoB$count)


```

Como existem dois dias que tem um conjunto menor de dados  podemos utilizar como unidade a hora e ver o valor proporcional.
```{r}

buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date, session_id, click, group)%>%
    ggplot(aes(x = session_start_date)) + 
    geom_bar(aes(fill = click))+facet_grid(group ~ .)+
   labs(fill="")
```

```{r}
NumeroDeBuscasSemClickPorHora <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "zero results rate" )%>%
    summarise(count=n())

NumeroDeBuscasComClickPorHora <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "clickthrough rate" )%>%
    summarise(count=n())

NumeroDeBuscasTotalPorHora <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    summarise(count=n())


mean(NumeroDeBuscasComClickPorHora$count/NumeroDeBuscasTotalPorHora$count)
mean(NumeroDeBuscasSemClickPorHora$count/NumeroDeBuscasTotalPorHora$count)


```

```{r}
NumeroDeBuscasSemClickPorHoraGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "zero results rate" & group == 'a')%>%
    summarise(count=n())

NumeroDeBuscasComClickPorHoraGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "clickthrough rate" & group == 'a')%>%
    summarise(count=n())

NumeroDeBuscasTotalPorHoraGrupoA <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter( group == 'a')%>%
    summarise(count=n())


mean(NumeroDeBuscasComClickPorHoraGrupoA$count/NumeroDeBuscasTotalPorHoraGrupoA$count)
mean(NumeroDeBuscasSemClickPorHoraGrupoA$count/NumeroDeBuscasTotalPorHoraGrupoA$count)


```

```{r}

NumeroDeBuscasSemClickPorHoraGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "zero results rate" & group == 'b')%>%
    summarise(count=n())
    

NumeroDeBuscasComClickPorHoraGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter(click == "clickthrough rate" & group == 'b')%>%
    summarise(count=n())

NumeroDeBuscasTotalPorHoraGrupoB <- buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>% 
    mutate(click = as.factor(ifelse(num_clicks == 0, 
                             "zero results rate", 
                             "clickthrough rate"
        ))) %>%
    group_by(session_start_date)%>%
    filter( group == 'b')%>%
    summarise(count=n())

mean(NumeroDeBuscasComClickPorHoraGrupoB$count/NumeroDeBuscasTotalPorHoraGrupoB$count)
mean(NumeroDeBuscasSemClickPorHoraGrupoB$count/NumeroDeBuscasTotalPorHoraGrupoB$count)


```

Como o resultado geral temos que o clickthrough rate aproximadamente 25% e o zero results rate aproximadamente 75%.Como podemos ver o grupo A tem um maior clickthrough rate que o grupo B essa diferença está em torno de 14%. Como podemos ver utilizar a hora como unidade melhorou os indices de clickthrough rate para os dois grupos.

##Which results do people tend to try first? How does it change day-to-day?

Para evitar problemas nos dados iremos remover as buscas que não tivera cliques e as buscas que tem um primeiro clique que é maior que os resultados mostrados ao usuário.s

```{r}
buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter(!is.na(first_click) & first_click <= results)%>%
    group_by(session_start_date)%>%
    ggplot(aes(x = session_start_date, y = first_click)) +
    geom_point(alpha=0.4)
```
```{r}
buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "day")) %>%
    filter(!is.na(first_click) & first_click <= results)%>%
    ggplot(aes(x = session_start_date, y = first_click)) +
    geom_jitter(alpha=0.4)+
   labs(fill="")
```

```{r}
buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter(!is.na(first_click) & first_click <= results)%>%
    group_by(session_start_date)%>%
    summarise(mediana = median(first_click))%>%
    ggplot(aes(x = session_start_date, y = mediana)) +
    geom_point(alpha=0.4)
```

```{r}
buscas %>% 
    mutate(session_start_date = round_date(session_start_date, unit = "hour")) %>%
    filter(!is.na(first_click) & first_click <= results)%>%
    group_by(session_start_date)%>%
    summarise(media = mean(first_click))%>%
    ggplot(aes(x = session_start_date, y = media)) +
    geom_point(alpha=0.4)
```

Como podemos ver nos gráficos os dados não relativos ao primeiro clique não variam em relação aos dias e quase todos eles estão localizados na primeira página levando em consideração que sejam exibidos 20-25 por página. O que significa que a maioria do usários buscam respostas na primeira página. 

##Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.

```{r}
events %>% 
    group_by(session_id)%>%
    arrange(date)%>%
    filter(search_index > 0)%>%
    summarise(diferenca = as.numeric(difftime((last(date) + ifelse(is.na(last(checkin)), 
                             0, 
                             last(checkin)
        )), first(date), units = "sec")) ,
              num_clicks = sum(action == "visitPage"))%>%
    ggplot(aes(x = diferenca , y = num_clicks )) +
    scale_x_log10()+
    geom_point(alpha = 0.4)
    
```


Intuitivamente, acreditamos que se uma sessão quando está durando pode significar duas coisas que são: O usuário encontou o que estava procurando e ficou lendo o artigo ou não encontrou o que procurava e continua fazendo pesquisas. Aqui tentamos associar a quantidade de acessos de itens nas pesquisas  com o tamanho da sessão. Como podemos ver a quantidade de acesso a itens tende a crescer junto com a sessão até determinado ponto e a partir desse ponto o número de cliques fica próximo de um. Uma explicação para esse comportamento é que os usuário que tem uma sessão maior que o ponto que muda o comportamento acharam de primeira e ficaram lendo o artigo sobre o que procuravam.Já nos casos que o número de clique cresceu com a sessão mostra que o usuário não tava satisfeito com os resultados mostrados e continuou procurando até um ponto em que encontou um resultado útil.